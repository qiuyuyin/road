# 鉴权系统

鉴权系统可以使用多种设计方式，随着系统从单体应用到分布式应用，系统的设计也在不断的进行迭代。

### 何为鉴权系统

鉴权系统分为登录服务和登录后的权限验证服务，首先用户进行登录，登录之后通过携带验证条目来对后台接口进行访问，在访问的过程中进行鉴权来过滤用户是否可以通过。

-   cookie- SessionID鉴权
-   jwt-鉴权
-   分布式单点登录系统设计

### 1.SessionID鉴权

SessionID鉴权是一个较为古早的鉴权方式，现在的系统一般不使用这种方式。

#### 1.1何为SessionID

在Cookie里放个SessionID，在服务器中存上Session具体内容，用户请求来了，根据SessionID去服务器里查是否存在对应的状态信息并且判断这个状态信息是否过期，这是Tomcat的实现方法。也就是

#### 1.2鉴权过程

学习过前端的朋友都知道，在浏览器中可以使用cookie来保存信息，这个cookie指的是可以自己保存在客户端的信息，也可能是通过访问后台之后进行set-cookie所得到的信息。

既然Cookie可以对浏览器数据进行保存，那么服务端是如何使用这个cookie的呢，这个时候就需要使用session来进行处理。具体流程如下：

![image-20220120153946664](https://yili979.oss-cn-beijing.aliyuncs.com/img/image-20220120153946664.png)

#### 1.3缺点

SessionID是存在现成的Tomcat服务器中的，但是现在的分布式系统不仅仅只有一个服务器，并且Session是直接存放在服务端的内存中的，如果SessionID数量过多会导致服务器性能下降。

同时sessionID的未加密存储还会存在安全问题，如果一个黑客通过xss注入获得你的sessionID，便可以使用你的sessionID来对系统进行系列操作，引发一系列的安全问题，有些时候甚至不需要注入，直接使用csrf攻击就可以直接对你的系统进行攻击。

### 2. JWT

#### 2.1 JWT为何而生

假设现在你想快速建设一个网站，并且打算将项目部署在分布式服务器上，如果使用SessionID需要采用Redis缓存来进行存储（如果使用Redis云数据库，非常贵的！），这个时候你上网搜索，发现了一个可以不用存储用户机制的鉴权服务——JWT。同时你会发现无论使用何种编程语言进行实现，JWT都会有现成的库提供给你使用。这个时候你便会欣喜若狂的使用JWT作为你的鉴权方式（虽然大公司系统都不会使用的啦，我研究了一下BiliBili，美团，阿里的网页Cookie，基本都是自己设计的一套Session实现方式，而不是使用开源的容易被破解的jwt来进行实现）。

#### 2.2JWT定义

Json Web Token

其实JWT并不只是用作鉴权系统，由于JWT可以对Json数据进行存储，所以理论上可以用于所有的信息交互服务。

#### 2.3JWT格式

JWT由三部分组成：header + payload + signature

![997EDE1C-5689-4C3F-98E8-25C25BBEC3FC](https://yili979.oss-cn-beijing.aliyuncs.com/img/997EDE1C-5689-4C3F-98E8-25C25BBEC3FC.png)

##### （1） HEADER

Header 部分是一个 JSON 对象，描述 JWT 的元数据：

```js
{
  "alg": "HS256",
  "typ": "JWT"
}
```

alg表示的这个签名生成的算法，存在集中签名算法进行选择，typ表示的是这个令牌的类型，统一写为JWT

##### （2）PAYLOAD

Payload部分也是一个JSON对象，保存着你实际要传递的参数，这个参数可以用你自己的写法来书写，不过JWT官方提供了7个字段来供你使用，这个是官方的规范，可以参照这个来对你需要输入的内容来进行表达。

-   iss (issuer)：签发人
-   exp (expiration time)：过期时间
-   sub (subject)：主题
-   aud (audience)：受众
-   nbf (Not Before)：生效时间
-   iat (Issued At)：签发时间
-   jti (JWT ID)：编号

##### （3）SIGNATURE

如果只是使用一个Header和Payload，是不是太过平平无奇了，这个不就是发送了一个JSON格式的文件，那如何进行校验呢？

这个时候就需要使用signature来对Payload和Header中的数据进行加密处理，得到一个密文作为Signature，如下图所示，sstr为header+'.'+payload，key为密钥，然后使用Sign方法来将sstr转化为一个加密串。

![image-20220121201233259](https://yili979.oss-cn-beijing.aliyuncs.com/img/image-20220121201233259.png)

同时签名算法有很多种选择，这里使用的是基于golang的JWT库，不同的签名算法之间存在着不小的区别，比如在HS256中使用的是对称加密，也就是说只能在同一个服务端进行验证，因为只存在一个密钥来对数据进行加密和解密。但是RS和ES是使用非对称的方式来对数据进行加密和解密，熟悉首先将数据通过私钥进行加密，可以将公钥发送到别的第三方认证中心进行加密和解密。

![image-20220121203025384](https://yili979.oss-cn-beijing.aliyuncs.com/img/image-20220121203025384.png)

由于实在是不想画图了，就省略JWT进行鉴权的流程。

### 3.SSO

#### 3.1何为SSO

**百度百科**

单点登录(SingleSignOn，SSO)，就是通过用户的一次性鉴别登录。当用户在[身份认证服务器](https://baike.baidu.com/item/身份认证服务器/10881881)上登录一次以后，即可获得访问单点登录系统中其他关联系统和应用软件的权限，同时这种实现是不需要管理员对用户的登录状态或其他信息进行修改的，这意味着在多个应用系统中，用户只需一次登录就可以访问所有相互信任的应用系统。这种方式减少了由登录产生的时间消耗，辅助了用户管理，是比较流行的。

#### 3.2一个实例

如果你有在web中登录过google的系列网站的话,仅仅登录一次就会将所有的google旗下网站全部登录。（有时候我真的想吐槽一点就是国内互联网有些过于侧重于移动端发力了，在移动端的h5里面都是各种导流到APP，而国外的软件公司在这方面基本是没有倾向性的）

想要理解SSO，那就让我们来看一个十分有意思的实例吧。

如果你要登录一个google的服务，会直接跳转到google账号中心：

![image-20220122161740847](https://yili979.oss-cn-beijing.aliyuncs.com/img/image-20220122161740847.png)

在account中心登录之后，访问google官网 www.google.com 之后，可以发现已经是登录状态了：

![image-20220122163248583](https://yili979.oss-cn-beijing.aliyuncs.com/img/image-20220122163248583.png)

然后无论访问任何google的服务都是登录状态

![image-20220122164420268](https://yili979.oss-cn-beijing.aliyuncs.com/img/image-20220122164420268.png)

不过不同域名之下的策略并不相同，像阿里的登录服务基本都是将服务放在了taobao.com的一级域名所描述的cookie之下，而由于google中存在youtubu这个单独域名的服务，但是youtubu的所保存的登录态并不是在google.com的域名之下

（可能非常绕，这些类似的token或者sessionID等鉴权服务需要一个存储的地方，这个地方一般是cookie，因为cookie可以进行域名隔离，相同根域名的服务比如www.google.com和translate.google.com之间是共用的google.com的cookie的，所以他们之间的登录态是可以互相访问的，但是如果你访问youtube.com的时候是无法访问google.com的cookie的，这个时候就考验了谷歌系统设计工程师的能力了）

我尝试将youtube中的cookie全部删除之后，youtube登录态会直接消失，然后点击登录按钮会重定向到accout.youtube.com的页面中，重定向之后一会便自动显示为登录态。然后如果你在google.com的域名下进行登录的时候，会有一瞬间跳转到account.youtube.com这个域名下。

调查发现两个网页下的secure类cookie是一致的：

![image-20220122171646016](https://yili979.oss-cn-beijing.aliyuncs.com/img/image-20220122171646016.png)

![image-20220122171625892](https://yili979.oss-cn-beijing.aliyuncs.com/img/image-20220122171625892.png)

这么看来google确实是在速度方面做了一些妥协来兼容他旗下两大域名之间的登录态。保证用户在登录google账号之后免于登录Youtube的烦恼。

以上的测试我是基于safari来进行测试而不是基于chorme，可能是google在自家浏览器中做了一些优化导致在chrome中进行登录是不需要跳转到Youtube到域名上的（也可能是太快了或者在内部进行跳转。

#### 3.3SSO总结

在一些大的系统中需要对多个种类的应用进行统一登录，比如使用谷歌全家桶服务，那么就需要采用SSO来进行统一管理。

每一个单独的应用只需要查看其根域名下是否存在一个对应身份验证的cookie，如果存在则表示这个应用为登录状态。

#### 3.4一些吐槽

源于中文互联网的用户基数，大多数C端服务都不采用Web的形式来对用户进行服务。

我们来看看中文互联网和外国互联网的一些区别：

首先是Google，旗下产品基本全部对Web端进行适配，哪怕是基本只在Android端进行使用的Google Play也保证了Web端端流畅运行，而且不会在用户进行浏览的过程中进行App导流：

![image-20220122202740126](https://yili979.oss-cn-beijing.aliyuncs.com/img/image-20220122202740126.png)

同时在移动端的Web应用Youtube中，所使用的页面几乎一摸一样，不存在任何导流的行为。

<img src="https://yili979.oss-cn-beijing.aliyuncs.com/img/Screenshot_2022-01-22-20-30-27-562_com.google.and.jpg" alt="Screenshot_2022-01-22-20-30-27-562_com.google.and" style="zoom:25%;" />

<img src="https://yili979.oss-cn-beijing.aliyuncs.com/img/Screenshot_2022-01-22-20-31-13-449_com.android.ch.jpg" alt="Screenshot_2022-01-22-20-31-13-449_com.android.ch" style="zoom:25%;" />

如果你感兴趣的话，可以直接看一下抖音的web端，会直接给你一个下载的地方，无法观看各种视频，但字节对外对tiktok则不一样，你同样是可以在移动端的Web中进行浏览的。我内心一直都明白这样做的原因所在，因为原生应用可以带来更多的广告，公司得以用牺牲一小部分用户的体验来得到利益的最大化，同时国内市场接触Web并未形成习惯导致多数用户基本养成了直接使用App的习惯。更让我不可忍受的是，不知道是哪个产品经理想出来的鬼点子，现在只要是有一定用户规模的C端App，大多都有什么赚金币兑换现金的操作，真的是绝了好吗，还有并夕夕的nt广告，互联网都被你们这些无知产品搞得臭气熏天！

### 4.Oauth鉴权

#### 4.1Oauth

为了节省用户注册的时间，减少用户的流失，基本上国内外互联网服务都选择了一种鉴权方式，OAuth鉴权。如果你觉得对这个名词感到模式，那换个方式来讲——**微信登录**。

>   给微信团队一个天大的赞👍，感谢没有在当今的互联网潮流中选择使用3-5s的开屏广告，没有在朋友圈系统中植入广告，没有在产品功能中加入太多复杂无用的功能。 

打开一个应用进行登录的时候，一般可以选择使用本机一键登录、手机验证码登录、第三方如微信登录。而Oauth就是第三方登录的专有名词，

#### 4.2方式

OAuth有四种获取令牌的方式，不管哪一种授权方式，第三方应用申请令牌之前，都必须先到系统备案，说明自己的身份，然后会拿到两个身份识别码：客户端 ID（client ID）和客户端密钥（client secret）。这是为了防止令牌被滥用，没有备案过的第三方应用，是不会拿到令牌的。

在前后端分离的情境下，我们常使用授权码方式，指的是第三方应用先申请一个授权码，然后再用该码获取令牌。

使用Github的流程图：

![img](https://yili979.oss-cn-beijing.aliyuncs.com/img/2019-08-20_13-25-16.png)

### 结尾

其实随着技术不断的迭代，还会出现更多更方便的用户鉴权方式提供给用户进行使用。

同时上述的方式中也没有说那一种最好，其实最适合的才是最好的，选择最为合适你的来对产品进行实现，同时可以参考各种新技术来满足你自己的系统来达到最好的用户交互性。

### 参考：

1.   [前后端常见的几种鉴权方式](https://juejin.cn/post/6844903927100473357)
2.   [jwt官网](https://jwt.io/)
3.   [JSON Web Token 入门教程](https://ruanyifeng.com/blog/2018/07/json_web_token-tutorial.html)
